# 云端实验室

## 基于华为云鲲鹏弹性云服务器部署Web应用

1. IAM用户登录
1. 服务列表 - 网络 - 虚拟私有云VPC
    - 访问控制 - **安全组**(同一个VPC内相互信任的云服务器, 默认组内云服务器可以相互访问, 出方向放行)
        - 创建安全组 - 入方向规则添加8080, 0.0.0.0/0

    - 创建 **虚拟私有云**
        - 区域
        - 网段
        - 子网
            - 可用区
            - 子网网段

1. 服务列表 - 计算 - 弹性云服务器ECS
    - 购买 **弹性云服务器**
        1. 基础配置
            - 计费模式
            - 区域
            - 可用区

            - CPU架构: x86, 鲲鹏
            - 规格
            - 镜像
            - 磁盘

        2. 网络配置
            - 网络
            - 安全组
            - 弹性公网IP
            - 线路: 全动态BGP, 静态BGP
            - 公网带宽: 按带宽计费, 按流量计费, 加入共享带宽
            - 带宽大小

        3. 高级配置
            - 登录凭证: 密码, 用户名

1. 部署
    1. 上传: `scp xxx.war root@EIP:/path/to/war`
    1. SSH: `ssh root@EIP`
    1. 下载Tomcat
    1. 拷贝war到webapps
    1. 启动Tomcat


## 基于云容器引擎部署NGINX应用

1. IAM用户登录
1. 服务列表 - 网络 - 虚拟私有云Virtual Private Cloud(VPC)
    - 创建虚拟私有云
        - 区域
        - 网段
        - 子网
            - 可用区
            - 子网网段

1. 服务列表 - 计算 - 弹性云服务器ECS
    - **密钥对**
        - 创建密钥对: 自动生成密钥对

1. 服务列表 - 容器服务 - 云容器引擎Cloud Container Engine(CCE)

    > Kubernetes集群, 支持部署和运行Docker容器应用

    > 基于角色的细粒度权限控制(RBAC)

    > 虚机, 裸金属, GPU等多种异构基础设施

    > 弹性伸缩

    - 购买Kubernetes集群
        1. 服务选型
            - 计费模式
            - 区域

            - 版本: v1.13.10, v1.15.6, v1.13.7
            - 集群管理规模: 50节点
            - 高可用

            - 虚拟私有云
            - 所在子网
            - 网络模型
            - 容器网段
            - 服务网段

            - 鉴权方式
            - 认证方式

        2. 创建节点
            - 计费模式
            - 区域
            - 可用区

            - 节点类型
            - 节点规格
            - 操作系统: EulerOS 2.5, CentOS 7.6
            - 系统盘
            - 数据盘

            - 虚拟私有云
            - 所在子网
            - 弹性IP
                - 规格: 全动态BGP, 静态BGP
                - 计费模式
                - 带宽类型: 独享
                - 带宽大小

            - 登录方式
                - 密钥对

        3. 配置确认

    - 资源管理 - 集群管理
    - 工作负载 - 无状态负载Deployment
        - 创建无状态工作负载
            1. 工作负载基本信息
                - 集群名称
                - 命名空间
                - 实例数量

            2. 容器设置
                - 添加容器 - 选择镜像 - Dockerhub官方镜像 - nginx
                - 基本信息
                    - 镜像版本
                    - 容器规格
                        - CPU配额: 申请, 限制
                        - 内存配额: 申请, 限制
                        - GPU配额, GPU显卡

            3. 工作负载访问设置
                - 添加服务
                    - 访问类型

                    - 服务亲和: 集群级别, 节点级别

                    - 端口配置: TCP 容器80 访问30758

            4. 高级设置
                - 升级策略: 滚动升级, 替换升级
                - 缩容策略
                - 迁移策略

        - 外部访问地址

### FAQ

1. ServiceStage: **微服务** 应用开发, 构建, 发布, 监控运维
1. 华为云产品基础服务存在应用中间件, 但是 **没有容器化**
1. 添加容器选择镜像时, 可以选择Dockerhub官方镜像, 存在redis, zookeeper, rabbitmq, 但不存在kafka
1. 容器镜像服务, 只提供镜像, 不提供高可靠, 负载均衡...


## ServiceStage

1. 我的凭证 - 访问密钥 - 下载AK/SK
1. 服务列表 - 网络 - 虚拟私有云Virtual Private Cloud(VPC)
1. 服务列表 - 计算 - 弹性云服务器ECS - 密钥对
1. 服务列表 - 应用服务 - 应用管理与运维平台ServiceStage
    1. 创建环境: ECS, CCE, CCI, EIP, RDS, DCS...
        1. 资源管理 - 创建 **租户面集群**, 选择VPC
        1. 创建节点, 选择规格(CPU, 内存, 存储), 弹性IP, 密钥对
        1. SSH制作镜像
            1. docker version
            1. Dockfile

        1. 软件中心 - 镜像仓库

    1. 创建应用: 包含多个组件
        1. 应用开发
            1. 微服务开发
                1. 工具下载 **CSE-SDK**
                1. 本地工程
                    1. 编辑microservice.yaml
                        - 服务中心地址
                        - 配置中心地址
                        - 服务看板地址
                        - AK/SK

                    1. 修改controller和测试用例
                    1. Maven构建
                    1. 运行Application

            1. 微服务管理
                1. 服务目录

    1. 新增组件
        1. 应用上线
            1. 应用管理 - 无状态应用
            1. 应用编排
                1. 模板 - 从设计器创建
                    1. 输入参数 - 镜像地址
                    1. 无状态应用(process/container), 容器组件(软件包镜像地址, 容器端口, 服务类型, 端口)
                    1. 关联关系
                    1. 校验, 保存, 下载, 部署(创建堆栈)

                1. 堆栈 - 访问方式

    1. 持续交付: 流水线包含构建, 代码检查, 测试用例, 部署升级
    1. 应用运维


## 容器镜像服务SWR

1. 登录仓库: 在节点上执行`docker login -u xxx -p xxx swr.cn-south-1.myhuaweicloud.com`
1. 拉取镜像: `docker pull swr.cn-south-1.myhuaweicloud.com/root/swr-demo-2048:latest`
1. 修改组织名称: `docker tag swr.cn-south-1.myhuaweicloud.com/root/swr-demo-2048:latest swr.cn-south-1.myhuaweicloud.com//swr-demo-2048:latest`
1. 推送镜像
