# 网络虚拟化

## Linux Bridge

相当于二层交换机, 负责数据转发, 多个网卡可以连接到同一个Linux Bridge, 当某个网卡接收到数据包时, Linux Bridge会将数据包转发给其他网卡。  
为了让VM可以访问网络，为VM1分配虚拟网卡vnet0（host中的TAP设备）通过Bridge br0与host的eth0相连。

### 配置实现

#### 配置Linux Bridge br0

在HOST上配置文件路径：`/etc/network/interfaces`

```
auto eth0
# 将dhcp获取方式改为manual
iface eth0 inet manual

# 新增网络设备
auto br0
# IP放到br0上
iface br0 inet dhcp
    bridge_stp off
    bridge_waitport 0
    bridge_fd 0
    # 将eth0挂到br0上
    bridge_ports eth0
```

重启HOST生效

!!! note "在HOST上查看bridge配置：`brctl show`"

##### NAT

virbr0是KVM默认创建的bridge, 为虚拟机网卡提供NAT功能。

默认分配一个IP, 并使用dnsmasq为虚拟机提供DHCP服务，在HOST中查看进程：`ps -ef | grep dnsmasq`

在`/var/lib/libvirt/dnsmasq/default.leases`中记录VM成功DHCP的IP

!!! check "使用NAT的VM只能访问外网, 但外网无法访问VM, 因为IP是virbr0 DHCP分配的, 经过了NAT转换"

!!! check "使用br0的VM可以通过自己的IP直接与外网通信"


#### 配置VM

- 方式一: 使用virt-manager图形化界面将VM1的网卡配置为br0。

!!! example "KVM命令行"
    - 查看虚拟机列表：`virsh list --all`  
    - 启动虚拟机：`virsh start VM1`
    - 查看VM接口列表：`virsh domiflist VM1`


## VLAN

LAN: 使用Hub或Switch连接，同一个广播域。

VLAN: Switch将端口划分出多个LAN。

!!! tip
    不同VLAN在三层网络可以互通。

交换机的端口有两种配置模式：Access和Trunk。

- Access口：端口属于VLAN，VLAN ID 1~4096。直接与计算机网卡相连，流入该口的数据包都被打上VLAN的标签。
- Trunk口：允许多个VLAN数据通过，通过时不更换VLAN标签。

### 网卡

- 物理网卡eth0: 服务器上实际的网络接口设备eth0, eth1...
- 子网卡eth0:1: 依赖于物理网卡，可以与物理网卡同时存在并使用不同的IP地址，使用自己的网络接口配置文件。{>>与物理网卡同时启用<<}
- ==虚拟VLAN== 网卡eth0.1: 没有自己的配置文件，通过 ==vconfig== 将物理网加入不同的VLAN自动生成。信息保存位置：`/proc/net/vlan/config`

!!! info
    1. VIP使用的是子网卡：`ifconfig eth0:0 x.x.x.x netmask 255.255.255.0 up`
    1. 启用VLAN虚拟网卡时，物理网卡接口上必须没有IP，且不能启用子网卡。

### ifconfig

/sbin/ifconfig: 查看，配置，启用，禁用网络接口的工具。

!!! warning
    通过ifconfig为网卡指定的IP地址，只是用来调试网络用的，不会更改系统关于网卡的配置文件。

语法：ifconfig 接口 IP hw MAC netmask 掩码 broadcast 广播 [up/down]

- ifconfig -a: 查看所有网络接口状态。
- ifconfig eth0: 查看特定网络接口状态。
- ifconfig eth1 hw ether xx:xx:xx:xx:xx:xx: 设置网卡MAC地址，其中hw后面所接的是网络接口类型：ether表示以太网，其他如ax25, ARCnet, netrom...

!!! quote "参考链接"
    <https://www.cnblogs.com/JohnABC/p/5951340.html>

## KVM实现VLAN

设置eth0的虚拟VLAN网卡eth0.10，VLANID为10。  
eth0.10, vnet0都挂在brvlan10上。  
Bridge上其他网络设备都自动加入到VLAN10中。

### 配置

在HOST上配置文件路径：`/etc/network/interfaces`，增加eth0.10, brvlan10, eth0.20, brvlan20，重启HOST。  
使用virt-manager分别将VM1, VM2的网卡挂到brvlan10, brvlan20上。

!!! note
    1. 通过VLAN隔离后，即使配置同一网段，VM1和VM2也不能互通。
    1. 物理交换机可以进行数据交换和隔离，而Linux VLAN只能隔离，因为eth0不能拥有同一个VLANID的虚拟VLAN网卡。Linux Bridge实现交换，将同一VLAN的子设备挂到同一个Bridge上。

## 总结

Linux Bridge + VLAN = 二层交换机


!!! quote "已读"
    - 9
    - 10
    - 11
