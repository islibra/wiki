# 0x01_架构

## keystone

认证和权限管理。

- user: person system service
    - admin, demo, nova, neutron, galance, cinder
- credentials
- authentication
- token
- project: 资源隔离，一个user可以有多个project
- service: nova计算，cinder块存储，swift对象存储，galance镜像，neutron网络
- endpoint: service通过url暴露自己的api。查看endpoint: `openstack catalog list`
- role: 查看角色：`openstack role list`，定义角色权限：`/etc/nova/policy.json`

## galance

管理nova创建VM时使用的镜像。

控制节点galance-api进程转发：
metadata: galance-registry进程，DB: mysql, su - stack, mysql, use galance, show tables
image: store backend
backend配置：etc/galance/galance-api.conf
查看镜像：galance image-list

## nova

管理VM的生命周期。

nova-compute组件安装在计算节点上，安装Hypervisor，上面运行虚拟机。  
nova-其他子服务和rabbitmq, mysql安装在控制节点上。

- 查看子服务分布：`nova service-list`
- 配置Hypervisor driver: `/etc/nova/nova.conf`
- 在keystone中查询nova-api的endpoint: `openstack endpoint show nova`

## neutron

提供网络服务，创建和管理L2, L3网络。

### 组件

- neutron server: 对外提供API，接收请求，调用plugin处理请求。
- neutron plugins: 处理server请求，维护逻辑网络状态，调用agent。
    - core plugin: 维护network, subnet, port
    - service plugin: 维护routing, firewall, load balance
- neutron agents: 运行在各节点。处理plugin请求，在provider上实现网络功能。
- network provider: 网络设备如Linux Bridge, Open vSwitch(OVS)或物理交换机。
- message queue: server, plugin, agent之间通信。
- neutron database(mysql): 存放network, subnet, port, router。

!!! note
    - 各服务的各组件都可以部署到不同的物理节点上。
    - plugin定义network，agent创建network。
    - plugin, agent, provider配套使用。

!!! example "创建一个VLAN=100的network"
    1. server接收到创建请求，通过queue(RabbitMQ)通知plugin
    1. plugin将network信息（名称，VLAN ID）保存到数据库，通过queue通知agent
    1. agent在节点的物理网卡上创建虚拟VLAN网卡如eth0.100，并创建bridge如brqxxx

### 部署

1. 控制节点：neutron server（集成core plugin, service plugin）
1. 控制节点或网络节点：core agent, service agent
1. 计算节点：core agent

## cinder

为VM提供Volume块存储。

## * swift

VM通过RESTful API存放对象数据。

## * ceilometer

监控，告警，计量。

## horizon

portal


!!! quote "已读"
    [OpenStack 架构 - 每天5分钟玩转 OpenStack（15）](https://mp.weixin.qq.com/s?__biz=MzIwMTM5MjUwMg==&mid=2653587909&idx=1&sn=b1297dc5cb49323a36a367122c1b1c4f&chksm=8d3081dcba4708ca61eacafb9d312e8278cbe380a00f01cc8f7cdba0bc1da1797f90df133051&scene=21#wechat_redirect)
